import{a as y,t as T,h as ee,n as ae}from"./template-Bf37FghY.js";import{p as Le,T as p,n as e,O as re,P as Ae,s as C,V as v,R as q,a as Se,Q as b,f as te,B as Q}from"./runtime-D_5eIJdB.js";import{i as j,s as I}from"./if-qkq15gDy.js";import{e as Ee}from"./each-BHgmS7vF.js";import{s as Me}from"./attributes-OnZxMmlQ.js";import{t as u}from"./class-BhzPnwhT.js";import{i as Pe,e as R,s as $e,a as G}from"./store-DSaKCGfv.js";import{b as Be}from"./input-BUIXpOkk.js";import{p as Ve}from"./props-Byy7dS6_.js";import{o as je}from"./index-client-DTALjsIX.js";import{d as Ie,w as Te}from"./index-BzKHlfNo.js";import{f as L,a as J}from"./analyses-DAMY3FoY.js";import De from"./FileCard-BB1sP6Oz.js";function He(){const{subscribe:A,set:P,update:n}=Te({files:[],currentFileId:null,isLoading:!1,error:null});return{subscribe:A,async loadFiles(){n(i=>({...i,isLoading:!0,error:null}));try{const i=await L.getAllFiles();n(t=>({...t,files:i,isLoading:!1}))}catch(i){console.error("Error loading files:",i),n(t=>({...t,error:i.message,isLoading:!1}))}},async uploadFile(i){n(t=>({...t,isLoading:!0,error:null}));try{let t=null;n(g=>{const m=g.files.find(B=>B.filename===i.name);return m&&(t=m.id),g});let o;if(t){console.log(`File with name ${i.name} already exists. Updating content.`);const g=await L.getFile(t),m=await i.arrayBuffer(),B={...g,content:m,size:i.size,type:i.type,updatedAt:new Date().getTime()};await L.updateFile(t,B),o=t}else o=await L.saveFile(i);const $=await L.getFile(o),{content:D,...E}=$;return n(g=>t?{...g,files:g.files.map(m=>m.id===o?E:m),currentFileId:o,isLoading:!1}:{...g,files:[...g.files,E],currentFileId:o,isLoading:!1}),o}catch(t){throw console.error("Error uploading file:",t),n(o=>({...o,error:t.message,isLoading:!1})),t}},async getFile(i){n(t=>({...t,isLoading:!0,error:null}));try{const t=await L.getFile(i),o=await L.fileRecordToFile(t);return n($=>({...$,isLoading:!1})),o}catch(t){throw console.error("Error getting file:",t),n(o=>({...o,error:t.message,isLoading:!1})),t}},async deleteFile(i){n(t=>({...t,isLoading:!0,error:null}));try{await L.deleteFile(i),n(t=>({...t,files:t.files.filter(o=>o.id!==i),currentFileId:t.currentFileId===i?null:t.currentFileId,isLoading:!1}))}catch(t){throw console.error("Error deleting file:",t),n(o=>({...o,error:t.message,isLoading:!1})),t}},setCurrentFile(i){n(t=>({...t,currentFileId:i}))},clearError(){n(i=>({...i,error:null}))}}}const h=He(),Re=Ie(h,A=>A.currentFileId?A.files.find(P=>P.id===A.currentFileId):null);var Ne=ae('<svg class="mr-1 h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>'),Oe=ae('<svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>'),Ue=T('<button class="flex items-center rounded-premium-sm bg-accent-warm px-premium-sm py-premium-xs text-premium-meta font-medium text-white transition-all duration-premium hover:bg-accent-copper disabled:cursor-not-allowed disabled:opacity-50"><!> </button>'),qe=T('<div class="absolute inset-0 z-10 flex items-center justify-center bg-white bg-opacity-90"><div class="text-center"><svg class="mx-auto mb-2 h-8 w-8 animate-spin text-accent-warm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <p class="text-premium-body text-text-slate">Clearing all files...</p> <p class="mt-1 text-premium-meta text-text-silver">This may take a moment</p></div></div>'),Qe=T('<div class="flex items-center justify-center p-premium-md text-text-slate"><svg class="mr-premium-sm h-5 w-5 animate-pulse-premium text-brand-royal" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span class="text-premium-body">Loading files...</span></div>'),Ge=T('<p class="p-premium-md text-center text-premium-body text-text-slate"> </p>'),Je=T('<div class="file-manager"><div class="mb-premium-md"><div class="mb-premium-sm flex items-center justify-between"><h2 class="text-premium-header font-semibold text-text-rich">Saved Files</h2> <!></div> <div class="mb-premium-sm flex flex-wrap items-center gap-premium-sm"><div class="relative flex-grow"><input type="text" placeholder="Search files..." class="w-full rounded-premium-sm border border-border-platinum py-premium-xs pl-8 pr-2 text-premium-meta"> <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-text-silver" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div> <div class="flex overflow-hidden rounded-premium-sm border border-border-platinum text-premium-meta"><button class="px-premium-sm py-premium-xs transition-all duration-premium"> </button> <button class="border-l border-border-platinum px-premium-sm py-premium-xs transition-all duration-premium"> </button> <button class="border-l border-border-platinum px-premium-sm py-premium-xs transition-all duration-premium"> </button></div></div></div> <div class="files-container relative max-h-96 overflow-y-auto rounded-premium border border-border-platinum"><!> <!></div></div>');function Ke(A,P){Le(P,!1);const[n,i]=$e(),t=()=>G(h,"$persistentFileStore",n),o=()=>G(J,"$analysisStore",n),$=()=>G(Re,"$currentFile",n),D=b(),E=b();let g=Ve(P,"onSelectFile",8,()=>{}),m=b(new Map),B=b(new Set),l=b("date"),F=b("desc"),V=b(""),N=b(!0),_=b(!1);je(async()=>{p(N,!0);try{await h.loadFiles(),await ie()}catch(r){console.error("Error loading files:",r)}finally{p(N,!1)}});async function ie(){for(const r of t().files)if(!e(m).has(r.id))try{const a=await h.getFile(r.id),s=await se(a);e(m).set(r.id,s)}catch(a){console.error(`Error loading preview for ${r.filename}:`,a),e(m).set(r.id,"Preview unavailable")}}async function se(r){try{return(await r.text()).split(`
`).slice(0,5).join(`
`)}catch(a){return console.error("Error generating preview:",a),"Preview unavailable"}}function le(r,a,s){return!r||!r.length?[]:[...r].sort((w,f)=>{let c=0;switch(a){case"name":c=(w.filename||"").localeCompare(f.filename||"");break;case"size":c=(w.size||0)-(f.size||0);break;case"date":default:c=(w.createdAt||0)-(f.createdAt||0);break}return s==="desc"?-c:c})}function oe(r,a){if(!a)return r;const s=a.toLowerCase();return r.filter(w=>(w.filename||"").toLowerCase().includes(s))}function O(r){e(l)===r?p(F,e(F)==="asc"?"desc":"asc"):(p(l,r),p(F,"desc"))}async function ne(r){try{h.setCurrentFile(r);const a=await h.getFile(r);g()({isSelection:!0,fileId:r,file:a})}catch(a){console.error("Error selecting file:",a)}}async function ce(r){try{const a=o().analyses.filter(s=>s.fileId===r);for(const s of a)await J.deleteAnalysis(s.id);await h.deleteFile(r),e(m).delete(r),p(m,e(m))}catch(a){console.error("Error deleting file:",a)}}async function de(){try{if(confirm("Are you sure you want to delete ALL files and their analyses? This cannot be undone.")){const r=t().files.map(s=>s.id);p(_,!0);const a=5;for(let s=0;s<r.length;s+=a){const w=r.slice(s,s+a);await Promise.all(w.map(async f=>{try{const c=o().analyses.filter(d=>d.fileId===f);await Promise.all(c.map(d=>J.deleteAnalysis(d.id).catch(x=>console.error(`Error deleting analysis ${d.id}:`,x)))),await h.deleteFile(f)}catch(c){console.error(`Error deleting file ${f}:`,c)}})),s+a<r.length&&await new Promise(f=>setTimeout(f,100))}p(m,new Map),await h.loadFiles(),h.setCurrentFile(null),p(_,!1)}}catch(r){console.error("Error clearing all files:",r),p(_,!1),alert("An error occurred while clearing files. Some files may not have been deleted.")}}re(()=>(t(),e(l),e(F)),()=>{p(D,le(t().files,e(l),e(F)))}),re(()=>(e(D),e(V)),()=>{p(E,oe(e(D),e(V)))}),Ae(),Pe();var K=Je(),W=v(K),X=v(W),me=C(v(X),2);{var ue=r=>{var a=Ue(),s=v(a);{var w=d=>{var x=Ne();y(d,x)},f=d=>{var x=Oe();y(d,x)};j(s,d=>{e(_)?d(w):d(f,!1)})}var c=C(s);q(()=>{a.disabled=e(_),Me(a,"title",e(_)?"Clearing files...":"Delete all files and their analyses"),I(c,` ${(e(_)?"Clearing...":"Clear All Files")??""}`)}),R("click",a,de),y(r,a)};j(me,r=>{t().files.length>0&&r(ue)})}var fe=C(X,2),Y=v(fe),pe=v(Y),ve=C(Y,2),z=v(ve),ge=v(z),k=C(z,2),we=v(k),S=C(k,2),he=v(S),xe=C(W,2),Z=v(xe);{var ye=r=>{var a=qe();y(r,a)};j(Z,r=>{e(_)&&r(ye)})}var be=C(Z,2);{var Fe=r=>{var a=Qe();y(r,a)},_e=r=>{var a=ee(),s=te(a);{var w=c=>{var d=Ge(),x=v(d);q(()=>I(x,e(V)?"No matching files found.":"No files saved yet. Upload a file to get started.")),y(c,d)},f=c=>{var d=ee(),x=te(d);Ee(x,1,()=>e(E),U=>U.id,(U,H)=>{const ze=Q(()=>{var M;return e(H).id===((M=$())==null?void 0:M.id)}),ke=Q(()=>e(B).has(e(H).id)),Ce=Q(()=>e(m).get(e(H).id));De(U,{get file(){return e(H)},get isActive(){return e(ze)},get showDetails(){return e(ke)},get preview(){return e(Ce)},$$events:{select:({detail:M})=>ne(M.id),delete:({detail:M})=>ce(M.id)}})}),y(c,d)};j(s,c=>{e(E).length===0?c(w):c(f,!1)},!0)}y(r,a)};j(be,r=>{e(N)?r(Fe):r(_e,!1)})}q(()=>{u(z,"bg-brand-royal",e(l)==="name"),u(z,"text-white",e(l)==="name"),u(z,"text-text-slate",e(l)!=="name"),u(z,"hover:bg-brand-whisper",e(l)!=="name"),u(z,"hover:text-brand-royal",e(l)!=="name"),I(ge,`Name ${(e(l)==="name"?e(F)==="asc"?"↑":"↓":"")??""}`),u(k,"bg-brand-royal",e(l)==="size"),u(k,"text-white",e(l)==="size"),u(k,"text-text-slate",e(l)!=="size"),u(k,"hover:bg-brand-whisper",e(l)!=="size"),u(k,"hover:text-brand-royal",e(l)!=="size"),I(we,`Size ${(e(l)==="size"?e(F)==="asc"?"↑":"↓":"")??""}`),u(S,"bg-brand-royal",e(l)==="date"),u(S,"text-white",e(l)==="date"),u(S,"text-text-slate",e(l)!=="date"),u(S,"hover:bg-brand-whisper",e(l)!=="date"),u(S,"hover:text-brand-royal",e(l)!=="date"),I(he,`Date ${(e(l)==="date"?e(F)==="asc"?"↑":"↓":"")??""}`)}),Be(pe,()=>e(V),r=>p(V,r)),R("click",z,()=>O("name")),R("click",k,()=>O("size")),R("click",S,()=>O("date")),y(A,K),Se(),i()}Ke.__docgen={version:3,name:"FileManager.svelte",data:[{name:"onSelectFile",visibility:"public",keywords:[],kind:"let",type:{kind:"function",text:"() => void"},static:!1,readonly:!1,defaultValue:"function"}],computed:[],methods:[],components:[],description:null,keywords:[],events:[],slots:[],refs:[]};export{Ke as default};
